# Сервис сбора данных (em-collector)

Микросервис `em-collector` отвечает за автоматическое получение, обработку и передачу информации о файлах данных из внешнего источника. Он регулярно проверяет наличие новых или обновленных архивов данных, загружает их, распаковывает и отправляет пути к извлеченным CSV-файлам в соответствующие топики Apache Kafka для дальнейшей обработки другими сервисами.

## Основной рабочий процесс

1.  **Планирование и запуск:**
    *   Процесс инициируется либо автоматически по расписанию (`GdeltScheduler`, по умолчанию каждую минуту), либо вручную через REST API эндпоинт `POST /api/v1/gdelt/process` (`GdeltController`).
    *   Оба способа запускают основной метод `GdeltService.processLatestArchives()`.

2.  **Получение списка архивов:**
    *   Сервис (`GdeltService`) использует Feign-клиент (`GdeltClient`) для запроса текстового файла `lastupdate-translation.txt` с официального ресурса GDELT. Этот файл содержит информацию о последних доступных архивах: размер, MD5-хеш и URL для каждого архива.
    *   Feign-клиент настроен с механизмом повторных попыток (`FeignClientConfig`) для обработки временных сетевых проблем.

3.  **Парсинг и проверка необходимости загрузки:**
    *   Полученный текстовый ответ парсится в список объектов `GdeltArchiveInfo`, каждый из которых представляет один архив.
    *   Для каждого архива из списка сервис обращается к `HashStoreService` (реализация `RedisHashStoreServiceImpl`), чтобы проверить, является ли архив новым или его содержимое изменилось. Проверка осуществляется путем сравнения текущего MD5-хеша (из `lastupdate-translation.txt`) с хешем, сохраненным в Redis для этого имени архива (ключ вида `gdelt:archive:hash:{archiveName}`).

4.  **Загрузка и обработка архивов (асинхронно):**
    *   Архивы, которые определены как новые или измененные, обрабатываются асинхронно (с использованием `Executor` на базе виртуальных потоков, настроенного в `AppConfig`).
    *   Для каждого такого архива:
        *   **Создание директорий:** Сервис (`GdeltService`) через `FileSystemService` проверяет и при необходимости создает директории для загрузки (`gdelt.storage.download-dir`) и распаковки (`gdelt.storage.extract-dir`) файлов.
        *   **Загрузка:** Архив загружается по URL с помощью `FileSystemService.downloadFile()`, который использует `java.net.http.HttpClient` для потоковой загрузки.
        *   **Проверка целостности:** После загрузки `FileSystemService.calculateMd5()` вычисляет MD5-хеш скачанного файла. Этот хеш и размер файла сравниваются с ожидаемыми значениями из `GdeltArchiveInfo`. Если они не совпадают, процесс для этого архива завершается с ошибкой.
        *   **Распаковка:** Если проверка прошла успешно, `FileSystemService.extractZipFile()` распаковывает содержимое ZIP-архива в целевую директорию (`gdelt.storage.extract-dir`). Этот метод включает защиту от уязвимости "Zip Slip".
        *   **Публикация события:** При успешной распаковке `GdeltService` публикует событие `ArchiveExtractedEvent`, содержащее информацию об исходном архиве (`GdeltArchiveInfo`) и список путей к извлеченным файлам (`List<Path>`).
        *   **Обновление хеша:** Новый MD5-хеш успешно обработанного архива сохраняется в Redis через `HashStoreService.storeHash()`.
        *   **Очистка:** Загруженный ZIP-архив удаляется после успешной распаковки.

5.  **Обработка события распаковки (асинхронно):**
    *   `ArchiveExtractedEventListener` асинхронно обрабатывает событие `ArchiveExtractedEvent`.
    *   Для каждого извлеченного файла (`Path`) из события:
        *   **Определение топика Kafka:** `GdeltTopicResolver` определяет целевой топик Kafka на основе имени исходного архива (используя `GdeltArchiveType` и `KafkaTopicProperties`). Например, файлы из архивов `*.translation.export.CSV.zip` пойдут в один топик, а из `*.translation.mentions.CSV.zip` — в другой.
        *   **Регистрация статуса отправки:** `FileSendStatusService` (реализация `RedisFileSendStatusServiceImpl`) регистрирует информацию об извлеченном файле в Redis (ключ `gdelt:file:info:{absoluteFilePath}`). Создается запись `ExtractedFileInfo` со статусом `isSent = false`. Эта запись имеет TTL (`7 дней` по умолчанию).
        *   **Отправка в Kafka:** Слушатель использует `KafkaMessageService` для отправки сообщения в определенный топик. Сообщение содержит **абсолютный путь** к извлеченному CSV-файлу в виде строки. Сервис инкапсулирует работу с `KafkaTemplate` и отслеживает результат отправки. Kafka-продюсер настроен на идемпотентность и повторные попытки.
        *   **Обновление статуса:** При получении подтверждения (ACK) от Kafka об успешной отправке сообщения, слушатель вызывает `FileSendStatusService.markAsSent()`, который обновляет статус файла в Redis на `isSent = true`. Если отправка не удалась, статус остается `false`.

6.  **Механизм повторной отправки в Kafka:**
    *   `FileSendRetryScheduler` запускается по расписанию (`gdelt.retry.interval`, по умолчанию `5 минут`).
    *   Он запрашивает у `FileSendStatusService` список всех файлов, у которых статус `isSent = false`.
    *   Для каждого такого файла планировщик проверяет, существует ли он еще на диске.
    *   Если файл существует, планировщик определяет нужный топик Kafka (через `GdeltTopicResolver`) и использует `KafkaMessageService` для повторной отправки пути к файлу в Kafka.
    *   `KafkaMessageService` автоматически обновляет статус файла на `isSent = true` через `FileSendStatusService` в случае успешной отправки.

## Обработка ошибок

*   **Сетевые ошибки:** Feign-клиент (`GdeltClient`) использует настроенный `Retryer` для повторных попыток при запросе списка архивов. Загрузка файлов (`HttpClient`) может выбросить `IOException`.
*   **Ошибки обработки:** Несоответствие хеша или размера файла, ошибки распаковки архива (`IOException`), ошибки при работе с Redis или Kafka логируются. Ошибки на уровне обработки GDELT могут приводить к выбрасыванию `GdeltProcessingException`.
*   **Ошибки Kafka:** `KafkaMessageService` управляет отправкой сообщений в Kafka и обрабатывает ошибки. Kafka-продюсер настроен на повторные попытки. Если отправка не удалась даже после повторов, статус файла в Redis остается `isSent = false`, и `FileSendRetryScheduler` попытается отправить его позже.
*   **Общая обработка:** `GlobalExceptionHandler` перехватывает основные исключения и возвращает стандартизированные ответы для REST API. Асинхронные задачи имеют обработчик неперехваченных исключений (`AppConfig`).

## Диаграмма последовательности

